<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android汽车G值与方向监测 - 修复版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: #bb86fc;
        }
        
        .android-info {
            background: rgba(3, 218, 198, 0.15);
            padding: 10px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .status-item {
            text-align: center;
            flex: 1;
            padding: 10px;
        }
        
        .value {
            font-size: 2rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .x-axis { color: #ff5252; }
        .y-axis { color: #4caf50; }
        .z-axis { color: #448aff; }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .gauge {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .gauge-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #bb86fc;
        }
        
        .direction-indicator {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 3px solid white;
        }
        
        .needle {
            position: absolute;
            bottom: 50%;
            left: 50%;
            width: 3px;
            height: 45%;
            background: #ff5252;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 0.1s;
        }
        
        .compass-markers {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        
        .marker {
            position: absolute;
            width: 2px;
            height: 10px;
            background: white;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .marker.n { top: 5px; height: 15px; background: #ff5252; }
        .marker.e { transform: translateX(-50%) rotate(90deg); right: 5px; left: auto; top: 50%; }
        .marker.s { transform: translateX(-50%) rotate(180deg); bottom: 5px; top: auto; }
        .marker.w { transform: translateX(-50%) rotate(270deg); left: 5px; top: 50%; }
        
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 25px;
            background: #03dac6;
            color: #000;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            color: #999;
        }
        
        button:hover:not(:disabled) {
            background: #00efd9;
            transform: scale(1.05);
        }
        
        .axis-label {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .max-g {
            color: #ff4d4d;
            font-weight: bold;
        }
        
        .g-force-indicator {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .g-force-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4caf50, #ffeb3b, #ff5252);
            transition: width 0.3s;
        }
        
        .debug-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .permission-help {
            background: rgba(255, 152, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
            }
            
            .status-item {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Android汽车G值与方向监测 - 修复版</h1>
            <p>使用手机传感器监测汽车运动过程中的加速度和方向变化</p>
            <div class="android-info">
                <strong>Redmi Turbo 3 / 澎湃OS 2.0 优化：</strong> 此版本针对您设备的传感器权限问题进行了特殊处理。
            </div>
            <div class="permission-help">
                <strong>权限提示：</strong> 如果点击"开始监测"后没有反应，请检查浏览器是否请求了运动传感器权限，并确保已授权。
            </div>
        </header>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="axis-label">X轴 (左右)</div>
                <div id="x-value" class="value x-axis">0.00 G</div>
            </div>
            <div class="status-item">
                <div class="axis-label">Y轴 (前后)</div>
                <div id="y-value" class="value y-axis">0.00 G</div>
            </div>
            <div class="status-item">
                <div class="axis-label">Z轴 (上下)</div>
                <div id="z-value" class="value z-axis">0.00 G</div>
            </div>
            <div class="status-item">
                <div class="axis-label">最大G值</div>
                <div id="max-g" class="value max-g">0.00 G</div>
                <div class="g-force-indicator">
                    <div id="g-force-fill" class="g-force-fill"></div>
                </div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="gauge">
                <div class="gauge-title">加速度G值实时监测</div>
                <canvas id="gChart" width="300" height="200"></canvas>
            </div>
            
            <div class="gauge">
                <div class="gauge-title">方向指示器</div>
                <div class="direction-indicator">
                    <div class="compass-markers">
                        <div class="marker n"></div>
                        <div class="marker e"></div>
                        <div class="marker s"></div>
                        <div class="marker w"></div>
                    </div>
                    <div class="needle" id="needle"></div>
                </div>
                <div id="direction-value" class="value" style="margin-top: 20px;">0°</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="gauge-title">G值历史变化</div>
            <canvas id="historyChart" height="200"></canvas>
        </div>
        
        <div class="controls">
            <button id="startBtn">开始监测</button>
            <button id="resetBtn">重置数据</button>
            <button id="calibrateBtn">校准传感器</button>
        </div>
        
        <div class="debug-info">
            <div id="debugLog">调试信息将显示在这里...</div>
        </div>
    </div>

    <script>
        // 全局变量
        let isMonitoring = false;
        let maxG = 0;
        let startTime = null;
        let historyData = {
            labels: [],
            datasets: [
                {
                    label: 'X轴 (左右)',
                    data: [],
                    borderColor: 'rgb(255, 82, 82)',
                    tension: 0.1,
                    pointRadius: 0
                },
                {
                    label: 'Y轴 (前后)',
                    data: [],
                    borderColor: 'rgb(76, 175, 80)',
                    tension: 0.1,
                    pointRadius: 0
                },
                {
                    label: 'Z轴 (上下)',
                    data: [],
                    borderColor: 'rgb(68, 138, 255)',
                    tension: 0.1,
                    pointRadius: 0
                }
            ]
        };
        
        // DOM元素
        const xValue = document.getElementById('x-value');
        const yValue = document.getElementById('y-value');
        const zValue = document.getElementById('z-value');
        const maxGValue = document.getElementById('max-g');
        const directionValue = document.getElementById('direction-value');
        const needle = document.getElementById('needle');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const calibrateBtn = document.getElementById('calibrateBtn');
        const gForceFill = document.getElementById('g-force-fill');
        const debugLog = document.getElementById('debugLog');
        
        // 添加调试信息
        function addDebugMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        // 检查传感器支持
        function checkSensorSupport() {
            if (!window.DeviceMotionEvent) {
                addDebugMessage("错误: 浏览器不支持DeviceMotionEvent");
                return false;
            }
            
            if (!window.DeviceOrientationEvent) {
                addDebugMessage("错误: 浏览器不支持DeviceOrientationEvent");
                return false;
            }
            
            addDebugMessage("传感器API支持检测通过");
            return true;
        }
        
        // 图表上下文
        const gChartCtx = document.getElementById('gChart').getContext('2d');
        const historyChartCtx = document.getElementById('historyChart').getContext('2d');
        
        // 初始化实时G值图表
        const gChart = new Chart(gChartCtx, {
            type: 'bar',
            data: {
                labels: ['X轴', 'Y轴', 'Z轴'],
                datasets: [{
                    label: '当前G值',
                    data: [0, 0, 0],
                    backgroundColor: [
                        'rgba(255, 82, 82, 0.7)',
                        'rgba(76, 175, 80, 0.7)',
                        'rgba(68, 138, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgb(255, 82, 82)',
                        'rgb(76, 175, 80)',
                        'rgb(68, 138, 255)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: '三轴加速度 (G)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 2,
                        min: -2
                    }
                }
            }
        });
        
        // 初始化历史数据图表
        const historyChart = new Chart(historyChartCtx, {
            type: 'line',
            data: historyData,
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '时间 (秒)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '加速度 (G)'
                        },
                        suggestedMin: -2,
                        suggestedMax: 2
                    }
                }
            }
        });
        
        // 开始/停止监测
        startBtn.addEventListener('click', function() {
            if (!isMonitoring) {
                startMonitoring();
            } else {
                stopMonitoring();
            }
        });
        
        // 重置数据
        resetBtn.addEventListener('click', function() {
            maxG = 0;
            maxGValue.textContent = '0.00 G';
            startTime = null;
            gForceFill.style.width = '0%';
            
            // 重置历史数据
            historyData.labels = [];
            historyData.datasets.forEach(dataset => {
                dataset.data = [];
            });
            historyChart.update();
            
            addDebugMessage("数据已重置");
        });
        
        // 校准传感器
        calibrateBtn.addEventListener('click', function() {
            if (isMonitoring) {
                addDebugMessage("请先停止监测再进行校准");
                return;
            }
            
            addDebugMessage("校准中...将设备放置在水平表面上");
            // 在实际应用中，这里应该记录当前传感器的偏移值
            setTimeout(() => {
                addDebugMessage("校准完成！");
            }, 2000);
        });
        
        // 开始监测函数 - 针对Android设备的修复
        function startMonitoring() {
            addDebugMessage("尝试启动传感器监测...");
            
            if (!checkSensorSupport()) {
                addDebugMessage("无法启动监测：传感器不支持");
                return;
            }
            
            // 针对Android设备的特殊处理
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS设备
                addDebugMessage("检测到iOS设备，请求权限...");
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startSensors();
                        } else {
                            addDebugMessage("用户拒绝了运动传感器权限");
                            alert('需要传感器权限才能使用此功能');
                        }
                    })
                    .catch(error => {
                        addDebugMessage("请求权限错误: " + error);
                        console.error('请求传感器权限错误:', error);
                    });
            } else {
                // Android设备 - 直接尝试启动
                addDebugMessage("Android设备检测，尝试直接启动传感器...");
                
                // 添加一个超时检查，如果几秒后还是没有数据，提示用户
                const timeoutId = setTimeout(() => {
                    if (!isMonitoring) {
                        addDebugMessage("传感器可能被阻止，请检查浏览器权限设置");
                        alert("请确保已授予浏览器运动传感器权限。\n\n在Chrome中：设置 > 网站设置 > 运动传感器");
                    }
                }, 3000);
                
                // 尝试直接启动传感器
                try {
                    startSensors();
                    // 如果成功启动，清除超时
                    clearTimeout(timeoutId);
                } catch (error) {
                    addDebugMessage("启动传感器时出错: " + error);
                    console.error("启动传感器时出错:", error);
                }
            }
        }
        
        function startSensors() {
            isMonitoring = true;
            startTime = Date.now();
            startBtn.textContent = '停止监测';
            startBtn.style.background = '#ff5252';
            
            // 监听设备方向变化
            window.addEventListener('devicemotion', handleMotionEvent);
            window.addEventListener('deviceorientation', handleOrientationEvent);
            
            addDebugMessage("传感器监听已启动");
        }
        
        // 停止监测函数
        function stopMonitoring() {
            isMonitoring = false;
            window.removeEventListener('devicemotion', handleMotionEvent);
            window.removeEventListener('deviceorientation', handleOrientationEvent);
            
            startBtn.textContent = '开始监测';
            startBtn.style.background = '#03dac6';
            
            addDebugMessage("传感器监听已停止");
        }
        
        // 处理运动事件
        function handleMotionEvent(event) {
            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration) {
                addDebugMessage("无法获取加速度数据");
                return;
            }
            
            const x = (acceleration.x / 9.81).toFixed(2);
            const y = (acceleration.y / 9.81).toFixed(2);
            const z = (acceleration.z / 9.81).toFixed(2);
            
            // 更新显示
            xValue.textContent = `${x} G`;
            yValue.textContent = `${y} G`;
            zValue.textContent = `${z} G`;
            
            // 更新实时图表
            gChart.data.datasets[0].data = [x, y, z];
            gChart.update();
            
            // 计算并更新最大G值
            const currentG = Math.max(Math.abs(x), Math.abs(y), Math.abs(z));
            if (currentG > maxG) {
                maxG = currentG;
                maxGValue.textContent = `${maxG.toFixed(2)} G`;
            }
            
            // 更新G力指示器
            const gForcePercentage = Math.min(100, (currentG / 2) * 100);
            gForceFill.style.width = `${gForcePercentage}%`;
            
            // 更新历史数据
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            historyData.labels.push(elapsedTime);
            historyData.datasets[0].data.push(x);
            historyData.datasets[1].data.push(y);
            historyData.datasets[2].data.push(z);
            
            // 保持数据点数量不超过100个
            if (historyData.labels.length > 100) {
                historyData.labels.shift();
                historyData.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }
            
            historyChart.update();
        }
        
        // 处理方向事件
        function handleOrientationEvent(event) {
            const direction = event.alpha; // 0-360度，表示设备围绕Z轴的方向
            if (direction === null) {
                addDebugMessage("无法获取方向数据");
                return;
            }
            
            directionValue.textContent = `${direction.toFixed(1)}°`;
            
            // 更新方向指示器
            needle.style.transform = `translateX(-50%) rotate(${direction}deg)`;
        }
        
        // 初始状态
        addDebugMessage("页面加载完成");
        addDebugMessage("设备信息: " + navigator.userAgent);
        
        // 检查传感器支持
        checkSensorSupport();
        
        // Android设备检测
        if (/android/i.test(navigator.userAgent)) {
            addDebugMessage("检测到Android设备");
            document.querySelector('h1').innerHTML += ' <span style="font-size: 1rem;">(Android)</span>';
        }
        
        // 添加一个测试按钮，用于手动触发传感器事件
        const testButton = document.createElement('button');
        testButton.textContent = '测试传感器';
        testButton.style.background = '#ff9800';
        testButton.onclick = function() {
            addDebugMessage("手动触发传感器测试...");
            if (window.DeviceMotionEvent) {
                addDebugMessage("DeviceMotionEvent支持: 是");
                // 尝试触发一个模拟事件来测试
                try {
                    const event = new DeviceMotionEvent('devicemotion', {
                        acceleration: { x: 0, y: 0, z: 0 },
                        accelerationIncludingGravity: { x: 0, y: 0, z: 9.81 },
                        rotationRate: { alpha: 0, beta: 0, gamma: 0 },
                        interval: 16
                    });
                    addDebugMessage("模拟传感器事件创建成功");
                } catch (e) {
                    addDebugMessage("模拟传感器事件失败: " + e.message);
                }
            } else {
                addDebugMessage("DeviceMotionEvent支持: 否");
            }
        };
        
        document.querySelector('.controls').appendChild(testButton);
    </script>
</body>
</html>