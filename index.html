<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汽车G值监测 - 重力补偿版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: #bb86fc;
        }
        
        .explanation {
            background: rgba(3, 218, 198, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .gauge {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .gauge-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #bb86fc;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .x-axis { color: #ff5252; }
        .y-axis { color: #4caf50; }
        .z-axis { color: #448aff; }
        .total-axis { color: #ffab00; }
        
        .axis-label {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 25px;
            background: #03dac6;
            color: #000;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background: #00efd9;
            transform: scale(1.05);
        }
        
        .calibration-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .calibration-steps {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .calibration-steps li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .dashboard, .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>汽车G值监测 - 重力补偿版</h1>
            <div class="explanation">
                <strong>为什么手机静止时Z轴显示1G？</strong> 这是因为加速度计测量的是包括重力在内的所有加速度。
                当手机静止时，重力加速度(9.8m/s²)作用于Z轴，显示为1G。本应用已添加重力补偿功能，使静止时显示接近0G。
            </div>
        </header>
        
        <div class="status-grid">
            <div class="status-item">
                <div class="axis-label">X轴 (左右加速度)</div>
                <div id="x-value" class="value x-axis">0.00 G</div>
            </div>
            <div class="status-item">
                <div class="axis-label">Y轴 (前后加速度)</div>
                <div id="y-value" class="value y-axis">0.00 G</div>
            </div>
            <div class="status-item">
                <div class="axis-label">Z轴 (垂直加速度)</div>
                <div id="z-value" class="value z-axis">0.00 G</div>
            </div>
            <div class="status-item">
                <div class="axis-label">合成加速度</div>
                <div id="total-value" class="value total-axis">0.00 G</div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="gauge">
                <div class="gauge-title">实时加速度监测</div>
                <canvas id="gChart" width="300" height="250"></canvas>
            </div>
            
            <div class="gauge">
                <div class="gauge-title">加速度历史变化</div>
                <canvas id="historyChart" height="250"></canvas>
            </div>
        </div>
        
        <div class="calibration-panel">
            <div class="gauge-title">重力校准</div>
            <p>为了获得准确的加速度测量值，请先进行重力校准：</p>
            <ol class="calibration-steps">
                <li>将手机平放在水平表面上（屏幕朝上）</li>
                <li>点击"开始校准"按钮并保持手机静止3秒</li>
                <li>校准完成后，应用将自动减去重力影响</li>
            </ol>
            <div class="controls">
                <button id="calibrateBtn">开始校准</button>
                <button id="startBtn">开始监测</button>
                <button id="resetBtn">重置数据</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let isMonitoring = false;
        let isCalibrating = false;
        let calibrationSamples = [];
        let gravityOffset = { x: 0, y: 0, z: 0 };
        let historyData = {
            labels: [],
            datasets: [
                {
                    label: 'X轴 (左右)',
                    data: [],
                    borderColor: 'rgb(255, 82, 82)',
                    tension: 0.1,
                    pointRadius: 0
                },
                {
                    label: 'Y轴 (前后)',
                    data: [],
                    borderColor: 'rgb(76, 175, 80)',
                    tension: 0.1,
                    pointRadius: 0
                },
                {
                    label: 'Z轴 (垂直)',
                    data: [],
                    borderColor: 'rgb(68, 138, 255)',
                    tension: 0.1,
                    pointRadius: 0
                }
            ]
        };
        
        // DOM元素
        const xValue = document.getElementById('x-value');
        const yValue = document.getElementById('y-value');
        const zValue = document.getElementById('z-value');
        const totalValue = document.getElementById('total-value');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const calibrateBtn = document.getElementById('calibrateBtn');
        
        // 初始化实时G值图表
        const gChart = new Chart(document.getElementById('gChart'), {
            type: 'bar',
            data: {
                labels: ['X轴', 'Y轴', 'Z轴'],
                datasets: [{
                    label: '当前G值',
                    data: [0, 0, 0],
                    backgroundColor: [
                        'rgba(255, 82, 82, 0.7)',
                        'rgba(76, 175, 80, 0.7)',
                        'rgba(68, 138, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgb(255, 82, 82)',
                        'rgb(76, 175, 80)',
                        'rgb(68, 138, 255)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: '三轴加速度 (G)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 2,
                        min: -2,
                        title: {
                            display: true,
                            text: '加速度 (G)'
                        }
                    }
                }
            }
        });
        
        // 初始化历史数据图表
        const historyChart = new Chart(document.getElementById('historyChart'), {
            type: 'line',
            data: historyData,
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '时间 (秒)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '加速度 (G)'
                        },
                        suggestedMin: -2,
                        suggestedMax: 2
                    }
                }
            }
        });
        
        // 开始/停止监测
        startBtn.addEventListener('click', function() {
            if (!isMonitoring) {
                startMonitoring();
                startBtn.textContent = '停止监测';
                startBtn.style.background = '#ff5252';
            } else {
                stopMonitoring();
                startBtn.textContent = '开始监测';
                startBtn.style.background = '#03dac6';
            }
        });
        
        // 重置数据
        resetBtn.addEventListener('click', function() {
            historyData.labels = [];
            historyData.datasets.forEach(dataset => {
                dataset.data = [];
            });
            historyChart.update();
        });
        
        // 校准重力
        calibrateBtn.addEventListener('click', function() {
            if (isMonitoring) {
                alert("请先停止监测再进行校准");
                return;
            }
            
            startCalibration();
        });
        
        // 开始校准
        function startCalibration() {
            isCalibrating = true;
            calibrationSamples = [];
            calibrateBtn.textContent = '校准中...';
            calibrateBtn.disabled = true;
            
            // 监听设备运动3秒
            window.addEventListener('devicemotion', calibrationHandler);
            
            // 3秒后完成校准
            setTimeout(finishCalibration, 3000);
        }
        
        // 校准处理函数
        function calibrationHandler(event) {
            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration) return;
            
            calibrationSamples.push({
                x: acceleration.x / 9.81,
                y: acceleration.y / 9.81,
                z: acceleration.z / 9.81
            });
        }
        
        // 完成校准
        function finishCalibration() {
            window.removeEventListener('devicemotion', calibrationHandler);
            
            // 计算平均值作为重力偏移
            const sampleCount = calibrationSamples.length;
            if (sampleCount > 0) {
                gravityOffset = calibrationSamples.reduce((sum, sample) => {
                    return {
                        x: sum.x + sample.x,
                        y: sum.y + sample.y,
                        z: sum.z + sample.z
                    };
                }, { x: 0, y: 0, z: 0 });
                
                gravityOffset.x /= sampleCount;
                gravityOffset.y /= sampleCount;
                gravityOffset.z /= sampleCount;
                
                // 调整Z轴偏移，使其包含重力
                gravityOffset.z -= 1;
            }
            
            isCalibrating = false;
            calibrateBtn.textContent = '校准完成';
            
            // 2秒后恢复按钮状态
            setTimeout(() => {
                calibrateBtn.textContent = '开始校准';
                calibrateBtn.disabled = false;
            }, 2000);
        }
        
        // 开始监测
        function startMonitoring() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startSensors();
                        } else {
                            alert('需要传感器权限才能使用此功能');
                        }
                    })
                    .catch(console.error);
            } else {
                startSensors();
            }
        }
        
        function startSensors() {
            isMonitoring = true;
            window.addEventListener('devicemotion', handleMotionEvent);
        }
        
        // 停止监测
        function stopMonitoring() {
            isMonitoring = false;
            window.removeEventListener('devicemotion', handleMotionEvent);
        }
        
        // 处理运动事件（添加重力补偿）
        function handleMotionEvent(event) {
            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration) return;
            
            // 转换为G值并应用重力补偿
            const x = (acceleration.x / 9.81 - gravityOffset.x).toFixed(2);
            const y = (acceleration.y / 9.81 - gravityOffset.y).toFixed(2);
            const z = (acceleration.z / 9.81 - gravityOffset.z).toFixed(2);
            
            // 计算合成加速度
            const total = Math.sqrt(x*x + y*y + z*z).toFixed(2);
            
            // 更新显示
            xValue.textContent = `${x} G`;
            yValue.textContent = `${y} G`;
            zValue.textContent = `${z} G`;
            totalValue.textContent = `${total} G`;
            
            // 更新实时图表
            gChart.data.datasets[0].data = [x, y, z];
            gChart.update();
            
            // 更新历史数据
            const elapsedTime = (historyData.labels.length / 10).toFixed(1);
            historyData.labels.push(elapsedTime);
            historyData.datasets[0].data.push(x);
            historyData.datasets[1].data.push(y);
            historyData.datasets[2].data.push(z);
            
            // 保持数据点数量不超过100个
            if (historyData.labels.length > 100) {
                historyData.labels.shift();
                historyData.datasets.forEach(dataset => {
                    dataset.data.shift();
                });
            }
            
            historyChart.update();
        }
        
        // 初始状态
        stopMonitoring();
    </script>
</body>
</html>
